name: Test
on: push

jobs:
  call-build-app-workflow:
    uses: ./.github/workflows/build-convene-web.yml

  test-rspec:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: [call-build-app-workflow]

    call-build-app-workflow-2:
      uses: ./.github/workflows/build-convene-web.yml

    steps:
      - name: Run Tests
        run: |
          # To wait for asset built
          # TODO: Start server in production mode
          curl --connect-timeout 5 --retry 5 --retry-delay 5 --retry-max-time 40 --retry-connrefused localhost:3000 1> /dev/null
          bundle exec rspec

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: feature-test-failed-screenshot
          path: features/test_reports/*.png

  test-features:
    name: Run Browser Tests
    runs-on: ubuntu-latest
    needs: [call-build-app-workflow]

    call-build-app-workflow-3:
      uses: ./.github/workflows/build-convene-web.yml

    steps:
      - name: Install Firefox
        uses: browser-actions/setup-firefox@latest

      - name: Run Tests
        run: |
          # To wait for asset built
          # TODO: Start server in production mode
          curl --connect-timeout 5 --retry 5 --retry-delay 5 --retry-max-time 40 --retry-connrefused localhost:3000 1> /dev/null
          yarn run test

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: feature-test-failed-screenshot
          path: features/test_reports/*.png
